<template>
  <div>
    <h1>이미지 업로드해서 스케치로 바꾸기</h1>
    <span>아직 안됨.. 하지만 이미지 업로드하면 미리보기 가능 !!</span>
    <div class="image-container">
      <input type="file" @change="onFileChange" />
      <img :src="imageUrl" v-if="imageUrl" />
    </div>
    <div>
      <img :src="sketch"/>
    </div>
    <button>돌아가기</button>
    <button @click="onSaveClick">저장하기</button>
  </div>
</template>

<script>
import { mapActions, mapState } from 'vuex'
const paintingStore = 'paintingStore'

export default {
  name: 'GenerateSketcheView',
  data () {
    return {
      imageUrl: ''
    }
  },
  computed: {
    ...mapState(paintingStore, ['paintingList', 'sketch'])
  },
  methods: {
    ...mapActions(paintingStore, ['getPaintingList', 'convertSketch', 'savePainting']),
    onFileChange (e) {
      const file = e.target.files[0]
      this.previewImage(file)
      const formData = new FormData()
      formData.append('image', file)
      this.convertSketch(formData)
    },
    previewImage (file) {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = e => {
        this.imageUrl = e.target.result
      }
    },
    Base64ToFile (imgBase64) {
      const byteString = atob(imgBase64.split(',')[1])
      const ab = new ArrayBuffer(byteString.length)
      const ia = new Uint8Array(ab)
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i)
      }
      const blob = new Blob([ab], { type: 'image/png' })

      // blob -> file
      const paintingFile = new File([blob], 'painting_' + new Date().getMilliseconds() + '.png', { type: 'image/png' })

      return paintingFile
    },
    onSaveClick () {
      const paintingFile = this.Base64ToFile(this.sketch)

      let data = {
        title: 'sketch_' + new Date().getMilliseconds(),
        type: 'LINE'
      }

      let formData = new FormData()
      formData.append('paintingFile', paintingFile)
      formData.append('data', new Blob([JSON.stringify(data)], {type: 'application/json'}))

      this.savePainting(formData)
        .then(
          alert('그림 저장에 성공했습니다.')
        )
        .catch(error => {
          alert('그림 저장에 실패했습니다.' + error)
        })

      this.$router.push('/painting/board')
    }
  }
}
</script>

<style>

</style>
