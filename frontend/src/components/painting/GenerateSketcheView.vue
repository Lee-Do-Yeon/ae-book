<template>
  <div>
    <input type="file" @change="onFileChange" />
    <div class="image-container">
      <div class="before">
        <p>원본</p>
        <img :src="imageUrl" v-if="imageUrl" />
      </div>
      <div class="after">
        <p>변환</p>
        <img :src="sketch"/>
      </div>
    </div>
    <button @click="goBack" class="ae-btn btn-navy">돌아가기</button>
    <button @click="onSaveClick" class="ae-btn btn-red">색칠하기</button>
  </div>
</template>

<script>
import { mapActions, mapState } from 'vuex'
const paintingStore = 'paintingStore'

export default {
  name: 'GenerateSketcheView',
  data () {
    return {
      imageUrl: ''
    }
  },
  computed: {
    ...mapState(paintingStore, ['paintingList', 'sketch'])
  },
  methods: {
    ...mapActions(paintingStore, ['getPaintingList', 'convertSketch', 'savePainting']),
    onFileChange (e) {
      const file = e.target.files[0]
      this.previewImage(file)
      const formData = new FormData()
      formData.append('image', file)
      this.convertSketch(formData)
    },
    previewImage (file) {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = e => {
        this.imageUrl = e.target.result
      }
    },
    Base64ToFile (imgBase64) {
      const byteString = atob(imgBase64.split(',')[1])
      const ab = new ArrayBuffer(byteString.length)
      const ia = new Uint8Array(ab)
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i)
      }
      const blob = new Blob([ab], { type: 'image/png' })

      // blob -> file
      const paintingFile = new File([blob], 'painting_' + new Date().getMilliseconds() + '.png', { type: 'image/png' })

      return paintingFile
    },
    onSaveClick () {
      if (this.sketch.type === 'sketch') {
        const paintingFile = this.Base64ToFile(this.sketch)

        let data = {
          title: 'sketch_' + new Date().getMilliseconds(),
          type: 'LINE'
        }

        let formData = new FormData()
        formData.append('paintingFile', paintingFile)
        formData.append('data', new Blob([JSON.stringify(data)], {type: 'application/json'}))

        if (sessionStorage.getItem('isLoginUser') === true) {
          this.savePainting(formData)
            .then(
              alert('선화를 저장에 성공했습니다.')
            )
            .catch(
              alert('선화 저장에 실패했습니다.')
            )
        }
      }
      this.$router.push('/painting/board')
    },
    goBack () {
      window.history.back()
    }
  }
}
</script>

<style scoped>
.image-container {
  margin: auto;
  width: 1000px;
  display: flex;
  flex-direction: row;
  min-height: 400px;
  margin-top: 20px;
  margin-bottom: 30px;
}

.image-container > div {
  border-radius: 10px;
  border: 1px solid var(--ae-navy);
}

.image-container p {
  font-weight: bold;
  font-size: 20px;
}

.before {
  width: 50%;
  margin-right: 30px;
}

.after {
  width: 50%;
}
</style>
